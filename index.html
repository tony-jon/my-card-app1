// OCR後のデータ解析部分（ここを差し替えてください）
const { data } = await worker.recognize(cv.toDataURL());
const lines = data.lines.map(l => ({
    text: l.text.trim().replace(/[|｜・.．]/g, ''), // 記号ノイズを除去
    size: l.bbox.y1 - l.bbox.y0,
    y: l.bbox.y0
})).filter(l => l.text.length > 1);

// 1. 【会社名】特定キーワードを全域から探す
const cKeywords = /株|通運|NIPPON|EXPRESS|CO|LTD|物流|支店|営業所/i;
let company = lines.find(l => cKeywords.test(l.text)) || lines[0];

// 2. 【氏名】会社名を除いた中で、最も「文字サイズ」が大きい行（2-10文字以内）
const nameCandidate = lines
    .filter(l => l.text !== company.text && l.text.length <= 10 && l.text.length >= 2)
    .sort((a, b) => b.size - a.size)[0];

// 3. 【住所】郵便番号起点で、次行まで繋ぐ
let fullAddress = "";
const addrIdx = lines.findIndex(l => /〒|[\d]{3}-[\d]{4}/.test(l.text));
if (addrIdx !== -1) {
    fullAddress = lines[addrIdx].text;
    // 下の行が「連絡先」でなければ、住所の続きとして結合
    const nextLine = lines[addrIdx + 1];
    if (nextLine && !/TEL|FAX|M|0\d0|http|@/i.test(nextLine.text)) {
        fullAddress += " " + nextLine.text;
    }
}

// 4. 【連絡先】
const telMatch = data.text.replace(/\s/g, '').match(/(0\d{1,4}-\d{1,4}-\d{4})/);

// 画面反映
document.getElementById('c').value = company ? company.text : "";
document.getElementById('n').value = nameCandidate ? nameCandidate.text : "";
document.getElementById('a').value = fullAddress.replace(/〒/g, '').trim();
document.getElementById('t').value = telMatch ? telMatch[0] : "";
