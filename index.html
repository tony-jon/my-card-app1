async function recognizeText() {
    const file = document.getElementById('photo').files[0];
    if (!file) return;

    const status = document.getElementById('ocrStatus');
    const rawTextArea = document.getElementById('rawText');
    status.innerText = "AI解析中...（文字をくっきり読み取ります）";

    try {
        // Tesseractのワーカーを作成し、詳細設定を行う
        const worker = await Tesseract.createWorker();
        await worker.loadLanguage('jpn+eng');
        await worker.initialize('jpn+eng');
        
        // 文字化けを防ぐために、認識する文字の候補をある程度絞る（オプション設定）
        await worker.setParameters({
            tessedit_char_whitelist: '0123456789-() 　abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ' +
                                     '亜唖娃阿哀愛挨逢葵茜穐悪握渥旭葦芦葦宛案闇暗...（常用漢字など）', 
            // ※実際には全ての漢字を書かなくても、jpnを指定していれば大丈夫ですが
            // 記号を減らすだけでノイズが減ります。
        });

        const { data: { text } } = await worker.recognize(file);
        
        // 読み取った後のノイズ（変な記号）を少し掃除する
        const cleanText = text.replace(/[^\w\sぁ-んァ-ヶ亜-熙\-\(\)\@\.\:]/g, '');

        rawTextArea.value = cleanText;

        const lines = cleanText.split('\n').map(l => l.trim()).filter(l => l.length > 1);
        
        if (lines.length > 0) {
            // 文字数が多い行や、特定のキーワードを含む行を除外して名前を探す工夫
            document.getElementById('name').value = lines[0] || "";
            document.getElementById('company').value = lines[1] || "";
            
            const phoneMatch = cleanText.match(/[\d-]{10,15}/);
            if (phoneMatch) {
                document.getElementById('phone').value = phoneMatch[0];
            }
        }
        
        await worker.terminate(); // 使い終わったらワーカーを終了
        status.innerText = "読み取り完了！";
    } catch (e) {
        console.error(e);
        status.innerText = "失敗しました。明るい場所で撮り直すか、直接入力してください。";
    }
}
