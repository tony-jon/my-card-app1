<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>最終対策版：ルビ完全除去スキャナー</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        .card { max-width: 480px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .status { background: #e7f3ff; color: #1877f2; padding: 10px; border-radius: 6px; text-align: center; font-weight: bold; margin-bottom: 20px; }
        label { font-size: 11px; font-weight: bold; color: #65676b; display: block; margin-top: 15px; }
        input { width: 100%; padding: 12px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .preview { width: 100%; border-radius: 8px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="card">
    <div id="st" class="status">名刺を撮影してルビ除去をテスト</div>
    <input type="file" id="up" accept="image/*">
    <img id="pv" class="preview">

    <label>会社名 (Company)</label><input type="text" id="c">
    <label>氏名 (Name / ルビを自動カット)</label><input type="text" id="n">
    <label>住所 (Address)</label><input type="text" id="a">
    <label>電話番号 (TEL)</label><input type="text" id="t">
</div>

<script>
const up = document.getElementById('up');
const st = document.getElementById('st');

up.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // プレビュー表示
    const reader = new FileReader();
    reader.onload = (re) => { document.getElementById('pv').src = re.target.result; };
    reader.readAsDataURL(file);

    st.innerText = "ルビ（フリガナ）を計算で除外中...";

    const img = await createImageBitmap(file);
    const cv = document.createElement('canvas');
    const ct = cv.getContext('2d');
    const sc = 2.0;
    cv.width = img.width * sc; cv.height = img.height * sc;
    ct.filter = 'grayscale(1) contrast(3) brightness(1.1)';
    ct.drawImage(img, 0, 0, cv.width, cv.height);

    const worker = await Tesseract.createWorker('jpn+eng');
    const { data } = await worker.recognize(cv.toDataURL());

    // --- 失敗を元にした新ロジック ---

    // 1. 全行を走査し、高さ(h)を計算。極端に小さい行（ルビ）は無視。
    const lines = data.lines.map(l => ({
        text: l.text.trim().replace(/[A-Z]{1,3}\s/g, ''), // 冒頭のBAなどのゴミを消去
        h: l.bbox.y1 - l.bbox.y0,
        y: l.bbox.y0
    })).filter(l => l.h > 30); // ★ルビ（通常15-20px）を物理的に切り捨てる

    // 2. 会社名：キーワード優先
    const compLine = lines.find(l => /日本通運|NIPPON|EXPRESS|株/i.test(l.text)) || lines[0];

    // 3. 氏名：漢字を含み、かつ「最も文字サイズが大きい」行を特定
    const nameLine = lines
        .filter(l => /[\u4E00-\u9FFF]/.test(l.text) && l.text.length < 10)
        .sort((a, b) => b.h - a.h)[0];

    // 4. 住所：郵便番号 〒 以降を抽出
    const addrLine = data.lines.find(l => /〒|[\d]{3}-[\d]{4}/.test(l.text));

    // 5. 電話番号
    const telMatch = data.text.replace(/\s/g, '').match(/(0\d{1,4}-\d{1,4}-\d{4})/);

    // 反映
    document.getElementById('c').value = compLine ? compLine.text : "";
    document.getElementById('n').value = nameLine ? nameLine.text.replace(/\s/g, '') : "";
    document.getElementById('a').value = addrLine ? addrLine.text : "";
    document.getElementById('t').value = telMatch ? telMatch[0] : "";

    await worker.terminate();
    st.innerText = "解析完了：ルビを除去しました";
};
</script>

</body>
</html>
