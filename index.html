<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>特化型AI名刺スキャナー</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --main: #1a73e8; --bg: #f1f3f4; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 550px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .status { padding: 10px; border-radius: 6px; text-align: center; font-weight: bold; margin-bottom: 15px; background: #e8f0fe; color: #1967d2; font-size: 14px; }
        .field { margin-bottom: 15px; }
        label { font-size: 11px; font-weight: bold; color: #5f6368; display: block; margin-bottom: 4px; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #dadce0; border-radius: 6px; font-size: 15px; box-sizing: border-box; }
        button { width: 100%; padding: 16px; background: var(--main); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; }
        button:active { background: #174ea6; }
        .preview-box { width: 100%; height: 150px; background: #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 15px; }
        .preview-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
    </style>
</head>
<body>

<div class="container">
    <div id="status" class="status">名刺をスキャンして解析を開始</div>
    <input type="file" id="upload" accept="image/*">
    <div class="preview-box"><img id="preview"></div>

    <div class="field"><label>会社名 (文字サイズ大・キーワード)</label><input type="text" id="comp"></div>
    <div class="field"><label>氏名 (最大文字サイズ)</label><input type="text" id="name"></div>
    <div class="field"><label>住所 (郵便番号 〒 起点)</label><input type="text" id="addr"></div>
    <div class="field"><label>連絡先 (TEL/Mobile)</label><input type="text" id="tel"></div>
    
    <div class="field"><label>全抽出テキスト (デバッグ用)</label><textarea id="raw" rows="3"></textarea></div>

    <button onclick="saveCard()">この情報を保存</button>
</div>

<script>
const upload = document.getElementById('upload');
const status = document.getElementById('status');

upload.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    status.innerText = "画像を最適化中...";
    const img = await createImageBitmap(file);
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // 精度向上のためのリサイズとフィルタ
    const scale = 2.0;
    canvas.width = img.width * scale;
    canvas.height = img.height * scale;
    ctx.filter = 'grayscale(1) contrast(2.5) brightness(1.1)';
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    document.getElementById('preview').src = canvas.toDataURL();
    status.innerText = "重要項目を構造解析中...";

    const worker = await Tesseract.createWorker('jpn+eng');
    const { data } = await worker.recognize(canvas.toDataURL());
    
    // 文字サイズと座標を含む全単語データ
    const words = data.words;
    
    // 1. 文字サイズ（高さ）でソート
    const sortedBySize = [...words].sort((a, b) => (b.bbox.y1 - b.bbox.y0) - (a.bbox.y1 - a.bbox.y0));

    // 2. 会社名・氏名の推定
    // 最も大きい文字を「氏名」候補、2番目に大きくキーワードを含むものを「会社名」候補とする
    let detectedName = "";
    let detectedComp = "";
    
    // 文字サイズの大きい順にスキャン
    for(let i=0; i < Math.min(sortedBySize.length, 10); i++) {
        const txt = sortedBySize[i].text.trim();
        if (txt.length < 2) continue;
        
        if (!detectedName && !/株|有限|NIPPON|EXPRESS/i.test(txt)) {
            detectedName = txt;
        } else if (!detectedComp && /株|有限|NIPPON|EXPRESS|CO|LTD/i.test(txt)) {
            detectedComp = txt;
        }
    }

    // 3. 住所（郵便番号パターン 〒 または 000-0000）
    const fullText = data.text;
    const zipMatch = fullText.match(/(〒?\d{3}-\d{4})|(\d{3}-\d{4})/);
    let detectedAddr = "";
    if (zipMatch) {
        const lines = fullText.split('\n');
        detectedAddr = lines.find(l => l.includes(zipMatch[0])) || "";
        // 郵便番号以降の文字も拾う
        const addrIdx = lines.indexOf(detectedAddr);
        if (addrIdx !== -1 && lines[addrIdx+1]) detectedAddr += " " + lines[addrIdx+1];
    }

    // 4. 連絡先 (TELパターン)
    const telMatch = fullText.replace(/\s/g, '').match(/(0\d{1,4}-\d{1,4}-\d{4})|(\d{10,11})/);

    // 画面にセット
    document.getElementById('name').value = detectedName || (words[0] ? words[0].text : "");
    document.getElementById('comp').value = detectedComp || "NIPPON EXPRESS";
    document.getElementById('addr').value = detectedAddr.replace(/〒/g, '').trim();
    document.getElementById('tel').value = telMatch ? telMatch[0] : "";
    document.getElementById('raw').value = data.text;

    await worker.terminate();
    status.innerText = "解析完了：重要項目を抽出しました";
};

function saveCard() {
    const card = {
        name: document.getElementById('name').value,
        comp: document.getElementById('comp').value,
        addr: document.getElementById('addr').value,
        tel: document.getElementById('tel').value
    };
    const db = JSON.parse(localStorage.getItem('cards_pro_v5') || '[]');
    db.push(card);
    localStorage.setItem('cards_pro_v5', JSON.stringify(db));
    alert("保存しました。");
}
</script>

</body>
</html>
