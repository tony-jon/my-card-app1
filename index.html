// OCR解析開始
const { data } = await worker.recognize(canvas.toDataURL());

// 全行を抽出し、高さ(h)と座標(y)を整理
const lines = data.lines.map(l => ({
    text: l.text.trim(),
    h: l.bbox.y1 - l.bbox.y0,
    y: l.bbox.y0
})).filter(l => l.text.length > 1);

// --- 1. 【会社名】キーワードヒットした行を全て連結 ---
const compKeywords = /日本通運|NIPPON|EXPRESS|NX|株式会社|株|CO|LTD|Inc|物流|通運/i;

let compParts = lines
    .filter(l => compKeywords.test(l.text))
    // 2文字以上の英字または漢字を含む行に限定（記号のみのノイズを排除）
    .filter(l => /[A-Za-z]{2,}|[\u4E00-\u9FFF]{2,}/.test(l.text))
    .sort((a, b) => a.y - b.y); // 上から順に並べる

// 重複を排除して結合
let finalComp = [...new Set(compParts.map(p => p.text))].join(' ');
// 不要なスローガンやロゴ誤認記号を除去
finalComp = finalComp.replace(/We Find the Way/gi, '').replace(/[|｜]/g, '').trim();

// --- 2. 【氏名】漢字のみを抽出してルビ(BAR等)を完全排除 ---
const nameCandidate = lines
    .filter(l => !compKeywords.test(l.text)) // 会社名行を除外
    .filter(l => l.h > 25)                   // 文字の高さでルビを除外
    .sort((a, b) => b.h - a.h)[0];           // 残った中で最大の行を選択

let finalName = "";
if (nameCandidate) {
    // 漢字・ひらがな・カタカナ以外を全て削除（BARなどの英字誤読を抹殺）
    finalName = nameCandidate.text.replace(/[^\u4E00-\u9FFF\u3040-\u309F\u30A0-\u30FF]/g, '');
}

// --- 3. 【住所】郵便番号(〒)を起点に特定 ---
const addrLine = lines.find(l => /〒|[\d]{3}-[\d]{4}/.test(l.text));

// --- 4. 結果表示 ---
document.getElementById('company').value = finalComp || (lines[0] ? lines[0].text : "");
document.getElementById('userName').value = finalName;
document.getElementById('address').value = addrLine ? addrLine.text : "";
