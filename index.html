<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>極限精度：AI名刺解析システム</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --main: #1a73e8; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 550px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .status { padding: 10px; border-radius: 6px; text-align: center; font-weight: bold; margin-bottom: 15px; font-size: 14px; background: #eee; }
        .working { background: #d2e3fc; color: #174ea6; }
        img#preview { width: 100%; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 15px; filter: grayscale(1) contrast(1.2); }
        .field { margin-bottom: 12px; }
        label { font-size: 12px; font-weight: 700; color: #5f6368; display: block; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: var(--main); color: #fff; border: none; border-radius: 8px; font-weight: 700; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="status" class="status">名刺写真をアップロード</div>
    <input type="file" id="fileIn" accept="image/*">
    <img id="preview" style="display:none;">

    <div class="field"><label>解析生テキスト</label><textarea id="raw" rows="6"></textarea></div>
    <div class="field"><label>氏名 (Name)</label><input type="text" id="name"></div>
    <div class="field"><label>会社名 (Company)</label><input type="text" id="comp"></div>
    <div class="field"><label>電話番号 (TEL)</label><input type="text" id="tel"></div>

    <button onclick="save()">データを保存する</button>
    <div id="log" style="margin-top:20px;"></div>
</div>

<script>
const fileIn = document.getElementById('fileIn');
const status = document.getElementById('status');

fileIn.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    status.className = "status working";
    status.innerText = "超解像・鮮明化処理中...";

    const img = await createImageBitmap(file);
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    // 1. 鮮明化のための拡大とフィルタリング
    const scale = 2.0; 
    canvas.width = img.width * scale;
    canvas.height = img.height * scale;
    
    // 文字を太く、くっきりさせるための多重フィルタ
    ctx.filter = 'grayscale(1) contrast(2) brightness(1.0) blur(0.5px)'; 
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    
    // 2. プレビュー表示
    const dataUrl = canvas.toDataURL('image/png');
    document.getElementById('preview').src = dataUrl;
    document.getElementById('preview').style.display = "block";

    status.innerText = "英日ハイブリッド解析中...";

    // 3. Tesseract実行 (eng+jpn を同時指定)
    const worker = await Tesseract.createWorker('eng+jpn');
    
    await worker.setParameters({
        tessedit_pageseg_mode: Tesseract.PSM.AUTO,
        tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ -.,@():/株式会社有限会社'
    });

    const { data } = await worker.recognize(dataUrl);
    const words = data.words;

    // 4. 座標ベースの行再構築 (横書き特化)
    const lines = [];
    let curY = -1;
    let curLine = "";
    const Y_LIMIT = 30 * scale; // 同じ行とみなすピクセル幅

    words.sort((a,b) => a.bbox.y0 - b.bbox.y0 || a.bbox.x0 - b.bbox.x0).forEach(w => {
        if (Math.abs(w.bbox.y0 - curY) > Y_LIMIT) {
            if (curLine) lines.push(curLine.trim());
            curY = w.bbox.y0;
            curLine = w.text;
        } else {
            curLine += " " + w.text;
        }
    });
    if (curLine) lines.push(curLine.trim());

    // 5. 結果の流し込み
    const fullText = lines.join('\n');
    document.getElementById('raw').value = fullText;

    // 氏名: yasuki takagi のようなアルファベット、または2-4文字の漢字を探す
    document.getElementById('name').value = lines.find(l => /^[A-Za-z ]+$/.test(l) || (l.length >= 2 && l.length <= 4)) || "";
    // 会社名: NIPPON EXPRESS など大文字が多い行、または「株」を含む行
    document.getElementById('comp').value = lines.find(l => l.includes('NIPPON') || l.includes('EXPRESS') || l.includes('株')) || lines[0];
    // 電話: 
    const telMatch = fullText.replace(/\s/g,'').match(/[\d-]{10,15}/);
    document.getElementById('tel').value = telMatch ? telMatch[0] : "";

    await worker.terminate();
    status.className = "status";
    status.innerText = "解析完了";
};

function save() {
    const card = { n: document.getElementById('name').value, c: document.getElementById('comp').value, t: document.getElementById('tel').value };
    const db = JSON.parse(localStorage.getItem('cards_final') || '[]');
    db.push(card);
    localStorage.setItem('cards_final', JSON.stringify(db));
    alert("保存しました");
    render();
}

function render() {
    const db = JSON.parse(localStorage.getItem('cards_final') || '[]');
    document.getElementById('log').innerHTML = db.reverse().map(x => `<div style="border:1px solid #ddd;padding:10px;margin-bottom:5px;border-radius:5px;"><b>${x.n}</b><br>${x.c}<br>${x.t}</div>`).join('');
}
window.onload = render;
</script>

</body>
</html>
