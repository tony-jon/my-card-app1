<script>
    function saveData() {
        const name = document.getElementById('name').value;
        if (!name) { alert("名前を入力してください"); return; }

        const file = document.getElementById('photo').files[0];
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // 写真を小さくリサイズする処理
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 400; // 横幅を400ピクセルに制限
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // 圧縮した画像データを作成
                    const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                    finalize(compressedData);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        } else {
            finalize(null);
        }

        function finalize(imgData) {
            const card = {
                name: name,
                company: document.getElementById('company').value,
                title: document.getElementById('title').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value,
                img: imgData
            };
            let data = JSON.parse(localStorage.getItem('cards')) || [];
            data.push(card);
            try {
                localStorage.setItem('cards', JSON.stringify(data));
                alert("写真付きで保存しました！");
                location.reload();
            } catch (e) {
                alert("保存容量がいっぱいです。古い名刺を削除してください。");
            }
        }
    }

    window.onload = function() {
        const data = JSON.parse(localStorage.getItem('cards')) || [];
        const list = document.getElementById('list');
        data.reverse().forEach((c, index) => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `<h3>${c.name}</h3><p>${c.company}</p><p>${c.title}</p><p>${c.address}</p><p>${c.phone}</p>`;
            if (c.img) div.innerHTML += `<img src="${c.img}">`;
            div.innerHTML += `<button onclick="deleteCard(${data.length - 1 - index})" style="background:#ff4444; color:white; border:none; padding:5px; width:auto;">削除</button>`;
            list.appendChild(div);
        });
    };

    function deleteCard(idx) {
        if(confirm("削除しますか？")) {
            let data = JSON.parse(localStorage.getItem('cards')) || [];
            data.splice(idx, 1);
            localStorage.setItem('cards', JSON.stringify(data));
            location.reload();
        }
    }
</script>
