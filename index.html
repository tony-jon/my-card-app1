async function recognizeText() {
    const file = document.getElementById('photo').files[0];
    if (!file) return;

    const status = document.getElementById('ocrStatus');
    const rawTextArea = document.getElementById('rawText');
    status.innerText = "画像を最適化して解析中...";

    // --- 画像の前処理 (Canvasを使用して白黒はっきりさせる) ---
    const img = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const i = new Image();
            i.onload = () => resolve(i);
            i.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = img.width;
    canvas.height = img.height;
    
    // グレースケール変換とコントラスト調整
    ctx.filter = 'grayscale(100%) contrast(150%) brightness(110%)';
    ctx.drawImage(img, 0, 0);
    
    // 最適化された画像データ
    const processedImageData = canvas.toDataURL('image/jpeg');

    try {
        // Tesseractの実行
        const result = await Tesseract.recognize(processedImageData, 'jpn+eng', {
            logger: m => console.log(m) // 進捗をコンソールに表示
        });
        
        const text = result.data.text;
        
        // 変な記号を除去し、日本語・英語・数字・改行・一部の記号だけに絞る
        const cleanText = text.replace(/[^\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF0-9a-zA-Z\s\-\.\:\@\(\)]/g, '');
        
        rawTextArea.value = cleanText;

        const lines = cleanText.split('\n').map(l => l.trim()).filter(l => l.length > 1);
        
        if (lines.length > 0) {
            document.getElementById('name').value = lines[0] || "";
            document.getElementById('company').value = lines[1] || "";
            
            const phoneMatch = cleanText.match(/[\d-]{10,15}/);
            if (phoneMatch) {
                document.getElementById('phone').value = phoneMatch[0];
            }
        }
        
        status.innerText = "読み取り完了！";
    } catch (e) {
        console.error(e);
        status.innerText = "解析失敗。明るい場所で撮影してください。";
    }
}
