<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIååˆºç®¡ç†ã‚¢ãƒ—ãƒª</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f4f4f4; margin: 0; }
        .container { max-width: 500px; margin: auto; }
        input, button, textarea { width: 100%; padding: 12px; margin: 5px 0; box-sizing: border-box; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; }
        button { background: #007bff; color: white; border: none; font-weight: bold; cursor: pointer; }
        .search-box { background: #fffde7; border: 2px solid #fbc02d; position: sticky; top: 0; z-index: 100; }
        .card { background: white; padding: 15px; margin-top: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card img { max-width: 100%; border-radius: 4px; margin-top: 10px; }
        .status { color: #d32f2f; font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .ocr-result-area { background: #e9ecef; font-size: 12px; height: 80px; resize: vertical; }
        .delete-btn { background: #ff4444; margin-top: 10px; padding: 8px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ååˆºç™»éŒ² (AIèª­ã¿å–ã‚Šä»˜)</h2>
        <div id="ocrStatus" class="status"></div>
        <input type="file" id="photo" accept="image/*" onchange="recognizeText()">
        
        <label style="font-size: 12px; color: #666;">èª­ã¿å–ã‚ŠåŸæ–‡:</label>
        <textarea id="rawText" class="ocr-result-area" placeholder="ã“ã“ã«èª­ã¿å–ã£ãŸãƒ†ã‚­ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>

        <input type="text" id="name" placeholder="åå‰">
        <input type="text" id="company" placeholder="ä¼šç¤¾å">
        <input type="text" id="phone" placeholder="é›»è©±ç•ªå·">
        <button onclick="saveCard()">ä¿å­˜ã™ã‚‹</button>

        <hr>
        <h2>ååˆºæ¤œç´¢</h2>
        <input type="text" id="searchInput" class="search-box" placeholder="åå‰ã‚„ä¼šç¤¾åã§æ¤œç´¢..." oninput="displayCards()">
        
        <div id="list"></div>
    </div>

    <script>
        async function recognizeText() {
            const file = document.getElementById('photo').files[0];
            if (!file) return;

            const status = document.getElementById('ocrStatus');
            const rawTextArea = document.getElementById('rawText');
            status.innerText = "æ–‡å­—ã‚’èª­ã¿å–ã‚Šä¸­...ï¼ˆæ•°åç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰";

            try {
                const result = await Tesseract.recognize(file, 'jpn+eng');
                const text = result.data.text;
                
                // åŸæ–‡ã‚’è¡¨ç¤º
                rawTextArea.value = text;

                // ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡ºå‡¦ç†
                const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                
                if (lines.length > 0) {
                    // 1è¡Œç›®ã‚’åå‰ã€2è¡Œç›®ã‚’ä¼šç¤¾åã¨ä»®å®šï¼ˆå¾®èª¿æ•´å¯èƒ½ï¼‰
                    document.getElementById('name').value = lines[0] || "";
                    document.getElementById('company').value = lines[1] || "";
                    
                    // é›»è©±ç•ªå·ã‚’æ­£è¦è¡¨ç¾ã§æ¢ã™ (æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®çµ„ã¿åˆã‚ã›)
                    const phoneMatch = text.match(/[\d-]{10,15}/);
                    if (phoneMatch) {
                        document.getElementById('phone').value = phoneMatch[0];
                    }
                }
                
                status.innerText = "èª­ã¿å–ã‚Šå®Œäº†ï¼";
            } catch (e) {
                console.error(e);
                status.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
            }
        }

        function saveCard() {
            const name = document.getElementById('name').value;
            if (!name) { alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            const file = document.getElementById('photo').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const width = 400; // å°‘ã—è§£åƒåº¦ã‚’ä¸Šã’ã¾ã—ãŸ
                        const scale = width / img.width;
                        canvas.width = width;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        finalize(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                finalize(null);
            }
        }

        function finalize(imgData) {
            const newCard = {
                name: document.getElementById('name').value,
                company: document.getElementById('company').value,
                phone: document.getElementById('phone').value,
                img: imgData
            };
            let cards = JSON.parse(localStorage.getItem('myAiCards')) || [];
            cards.push(newCard);
            localStorage.setItem('myAiCards', JSON.stringify(cards));
            alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
            
            // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('name').value = "";
            document.getElementById('company').value = "";
            document.getElementById('phone').value = "";
            document.getElementById('rawText').value = "";
            document.getElementById('photo').value = "";
            
            displayCards();
        }

        function displayCards() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cards = JSON.parse(localStorage.getItem('myAiCards')) || [];
            const list = document.getElementById('list');
            list.innerHTML = "";

            // æ–°ã—ã„é †ã«è¡¨ç¤º
            [...cards].reverse().forEach((c, i) => {
                const originalIndex = cards.length - 1 - i;
                if (c.name.toLowerCase().includes(searchTerm) || c.company.toLowerCase().includes(searchTerm)) {
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <h3>${c.name}</h3>
                        <p>ğŸ¢ ${c.company}</p>
                        <p>ğŸ“ ${c.phone}</p>
                    `;
                    if (c.img) div.innerHTML += `<img src="${c.img}">`;
                    div.innerHTML += `<button class="delete-btn" onclick="deleteCard(${originalIndex})">å‰Šé™¤</button>`;
                    list.appendChild(div);
                }
            });
        }

        function deleteCard(index) {
            if(confirm("ã“ã®ååˆºã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                let cards = JSON.parse(localStorage.getItem('myAiCards')) || [];
                cards.splice(index, 1);
                localStorage.setItem('myAiCards', JSON.stringify(cards));
                displayCards();
            }
        }

        window.onload = displayCards;
    </script>
</body>
</html>
