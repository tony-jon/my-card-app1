<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロ仕様：座標再構築型AI名刺管理</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --bg: #f1f3f4; }
        body { font-family: 'Sego UI', sans-serif; background: var(--bg); margin: 0; padding: env(safe-area-inset-top) 15px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .status { padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold; background: #e8f0fe; color: #1967d2; }
        .canvas-container { display: none; } /* 処理用Canvasは隠す */
        .preview-img { width: 100%; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; }
        .field-label { font-size: 12px; font-weight: bold; color: #5f6368; margin-top: 10px; }
        input, textarea { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #dadce0; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .btn-save { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .card { background: #fff; border: 1px solid #dadce0; padding: 15px; border-radius: 10px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div id="status" class="status">名刺をスキャンしてください</div>
    
    <input type="file" id="fileInput" accept="image/*" capture="camera">
    <img id="viewPreview" class="preview-img" style="display:none;">

    <div class="field-label">AI再構築テキスト</div>
    <textarea id="rawText" rows="5"></textarea>

    <div class="field-label">氏名</div>
    <input type="text" id="nameField">
    <div class="field-label">会社名</div>
    <input type="text" id="companyField">
    <div class="field-label">電話番号</div>
    <input type="text" id="phoneField">

    <button class="btn-save" onclick="saveData()">保存する</button>

    <div id="cardList"></div>
</div>

<canvas id="procCanvas" class="canvas-container"></canvas>

<script>
const fileInput = document.getElementById('fileInput');
const status = document.getElementById('status');

fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    status.innerText = "画像を最適化中...";
    
    const img = await createImageBitmap(file);
    const canvas = document.getElementById('procCanvas');
    const ctx = canvas.getContext('2d');

    // 1. 画像の向きを「横長」に強制正規化する
    // 横書き名刺を想定し、幅 > 高さ になるように描画
    if (img.height > img.width) {
        canvas.width = img.height;
        canvas.height = img.width;
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.rotate(90 * Math.PI / 180);
        ctx.drawImage(img, -img.width / 2, -img.height / 2);
    } else {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
    }

    // 2. 鮮明化（コントラスト調整）
    ctx.globalCompositeOperation = 'contrast';
    ctx.filter = 'contrast(1.5) grayscale(1) brightness(1.1)';
    ctx.drawImage(canvas, 0, 0);

    const processedData = canvas.toDataURL('image/jpeg', 0.9);
    document.getElementById('viewPreview').src = processedData;
    document.getElementById('viewPreview').style.display = "block";

    status.innerText = "座標ベースで文字を再構築中...";

    // 3. OCR実行
    const worker = await Tesseract.createWorker('jpn');
    const { data } = await worker.recognize(processedData);

    // 4. 座標ベースの再構築ロジック
    // 同じ行(y座標)にある単語をグループ化して、正しい「行」を作る
    const lines = [];
    let currentLine = { y: -1, text: "" };
    const threshold = 20; // 同じ行とみなす高さの許容範囲(px)

    const sortedWords = data.words.sort((a, b) => a.bbox.y0 - b.bbox.y0 || a.bbox.x0 - b.bbox.x0);

    sortedWords.forEach(word => {
        if (Math.abs(word.bbox.y0 - currentLine.y) > threshold) {
            if (currentLine.text) lines.push(currentLine.text);
            currentLine = { y: word.bbox.y0, text: word.text };
        } else {
            currentLine.text += " " + word.text;
        }
    });
    if (currentLine.text) lines.push(currentLine.text);

    const fullText = lines.join('\n').replace(/\s+/g, ' ');
    document.getElementById('rawText').value = fullText;

    // 5. 抽出
    const cleanLines = lines.map(l => l.trim()).filter(l => l.length > 1);
    document.getElementById('companyField').value = cleanLines.find(l => l.includes('株') || l.includes('有限')) || cleanLines[0] || "";
    document.getElementById('nameField').value = cleanLines.find(l => l.length >= 2 && l.length <= 8 && !l.includes('株')) || cleanLines[1] || "";
    const tel = fullText.replace(/[^\d-]/g, '').match(/\d{2,4}-\d{2,4}-\d{4}/);
    document.getElementById('phoneField').value = tel ? tel[0] : "";

    await worker.terminate();
    status.innerText = "スキャン完了";
};

function saveData() {
    const card = {
        name: document.getElementById('nameField').value,
        company: document.getElementById('companyField').value,
        phone: document.getElementById('phoneField').value
    };
    const list = JSON.parse(localStorage.getItem('cards_v3') || '[]');
    list.push(card);
    localStorage.setItem('cards_v3', JSON.stringify(list));
    alert("保存しました");
    render();
}

function render() {
    const list = JSON.parse(localStorage.getItem('cards_v3') || '[]');
    const div = document.getElementById('cardList');
    div.innerHTML = list.reverse().map(c => `<div class="card"><b>${c.name}</b><br>${c.company}<br>${c.phone}</div>`).join('');
}
window.onload = render;
</script>

</body>
</html>
