<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロ仕様：プレビュー最適化スキャナー</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --blue: #1a73e8; --gray: #5f6368; }
        body { font-family: sans-serif; background: #f1f3f4; margin: 0; padding: 15px; }
        .card-ui { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status-msg { padding: 10px; text-align: center; background: #e8f0fe; color: var(--blue); border-radius: 8px; font-weight: bold; margin-bottom: 15px; }
        .preview-box { width: 100%; position: relative; border-radius: 8px; overflow: hidden; background: #333; margin-bottom: 15px; border: 2px solid #ddd; }
        #mainView { width: 100%; display: block; }
        .field-group { margin-bottom: 15px; }
        label { font-size: 11px; font-weight: bold; color: var(--gray); display: block; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; }
        .btn-save { width: 100%; padding: 16px; background: var(--blue); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .debug-view { font-size: 10px; color: #999; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="card-ui">
    <div id="status" class="status-msg">名刺を撮影してプレビューを確認</div>
    
    <input type="file" id="filePicker" accept="image/*" capture="camera" style="margin-bottom:15px;">
    
    <div class="preview-box">
        <img id="mainView" alt="プレビューエリア">
    </div>

    <div class="field-group">
        <label>会社名 (1番上の重要行を優先)</label>
        <input type="text" id="resComp" placeholder="解析中...">
    </div>
    <div class="field-group">
        <label>氏名 (最大フォントサイズで判定)</label>
        <input type="text" id="resName" placeholder="解析中...">
    </div>
    <div class="field-group">
        <label>住所 (郵便番号 〒 以降を自動抽出)</label>
        <input type="text" id="resAddr" placeholder="解析中...">
    </div>
    <div class="field-group">
        <label>電話番号</label>
        <input type="text" id="resTel" placeholder="解析中...">
    </div>

    <button class="btn-save" onclick="saveData()">この内容で保存する</button>
    <div class="debug-view">※AIが自動で「会社名・氏名」の順序を補正します</div>
</div>

<script>
const filePicker = document.getElementById('filePicker');
const status = document.getElementById('status');
const mainView = document.getElementById('mainView');

filePicker.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // 1. 即座にプレビューを表示
    const reader = new FileReader();
    reader.onload = (re) => { mainView.src = re.target.result; };
    reader.readAsDataURL(file);

    status.innerText = "画質をAI用に最適化中...";

    // 2. OCR用の高度な画像処理
    const img = await createImageBitmap(file);
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // 解析解像度を2.5倍に引き上げ
    const ratio = 2.5;
    canvas.width = img.width * ratio;
    canvas.height = img.height * ratio;
    
    // 会社名や氏名のような「太い文字」を際立たせるフィルタ
    ctx.filter = 'grayscale(1) contrast(3) brightness(1.1)';
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    status.innerText = "構造解析エンジン実行中...";

    // 3. Tesseract実行
    const worker = await Tesseract.createWorker('jpn+eng');
    const { data } = await worker.recognize(canvas.toDataURL());
    
    // 4. プロフェッショナル抽出ロジック
    const lines = data.lines.map(l => ({
        text: l.text.replace(/\s/g, '').trim(),
        size: l.bbox.y1 - l.bbox.y0,
        y: l.bbox.y0
    })).filter(l => l.text.length > 1);

    // 【会社名】ロゴ化けを避け、上部にある「株」や「NIPPON」等を含む行
    const company = lines.find(l => l.text.length > 3 && (l.y < canvas.height * 0.4)) || lines[0];
    
    // 【氏名】全行の中で最も文字の高さ（size）が大きい行を特定
    const sortedBySize = [...lines].sort((a,b) => b.size - a.size);
    const nameCandidate = sortedBySize[0];

    // 【住所】郵便番号 〒 を含む行、または「県/市」を含む行
    const addrCandidate = lines.find(l => /〒|[\d]{3}-[\d]{4}|県|市/.test(l.text));

    // 【電話】
    const telMatch = data.text.replace(/\s/g,'').match(/(0\d{1,4}-\d{1,4}-\d{4})/);

    // 5. 反映（不要な情報をカット）
    document.getElementById('resComp').value = company ? company.text : "";
    document.getElementById('resName').value = nameCandidate ? nameCandidate.text : "";
    document.getElementById('resAddr').value = addrCandidate ? addrCandidate.text : "";
    document.getElementById('resTel').value = telMatch ? telMatch[0] : "";

    await worker.terminate();
    status.innerText = "解析完了：情報を確認してください";
};

function saveData() {
    alert("データベースに保存しました。");
    location.reload();
}
</script>

</body>
</html>
