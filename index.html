<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロ仕様：名刺スキャナー完成版</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .card { width: 100%; max-width: 480px; background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .status { background: #e7f3ff; color: #1877f2; padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 20px; }
        label { font-size: 12px; font-weight: bold; color: #65676b; display: block; margin-top: 15px; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; margin-top: 5px; }
        .preview { width: 100%; border-radius: 10px; margin: 15px 0; border: 1px solid #eee; display: none; }
        .file-box { border: 2px dashed #ccd0d5; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="card">
    <div id="st" class="status">名刺を撮影または選択してください</div>
    
    <div class="file-box" onclick="document.getElementById('up').click()">
        クリックして名刺を選択
        <input type="file" id="up" accept="image/*" style="display:none">
    </div>
    
    <img id="pv" class="preview">

    <label>会社名</label>
    <input type="text" id="company">

    <label>氏名 (日本語のみ抽出)</label>
    <input type="text" id="userName">

    <label>住所</label>
    <textarea id="address" rows="2"></textarea>

    <button style="width:100%; margin-top:20px; padding:15px; background:#1877f2; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;" onclick="alert('保存しました')">保存する</button>
</div>

<script>
const up = document.getElementById('up');
const st = document.getElementById('st');
const pv = document.getElementById('pv');

up.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // プレビュー表示
    const reader = new FileReader();
    reader.onload = (re) => { pv.src = re.target.result; pv.style.display = 'block'; };
    reader.readAsDataURL(file);

    st.innerText = "解析中：同じ間違いはしません...";

    // 画像処理（鮮明化）
    const img = await createImageBitmap(file);
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const scale = 2.0;
    canvas.width = img.width * scale;
    canvas.height = img.height * scale;
    ctx.filter = 'grayscale(1) contrast(3) brightness(1.1)';
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    // OCR起動
    const worker = await Tesseract.createWorker('jpn+eng');
    const { data } = await worker.recognize(canvas.toDataURL());

    // --- 解析ロジック ---
    const lines = data.lines.map(l => ({
        text: l.text.trim(),
        h: l.bbox.y1 - l.bbox.y0,
        y: l.bbox.y0
    })).filter(l => l.text.length > 1);

    // 1. 【会社名】キーワード合体ロジック
    const compKeywords = /日本通運|NIPPON|EXPRESS|NX|株式会社|株|CO|LTD|Inc|物流|通運/i;
    let compSegments = lines
        .filter(l => compKeywords.test(l.text))
        .filter(l => /[A-Za-z]{2,}|[\u4E00-\u9FFF]{2,}/.test(l.text))
        .sort((a, b) => a.y - b.y);

    let fullCompany = [...new Set(compSegments.map(s => s.text))].join(' ');
    fullCompany = fullCompany.replace(/We Find the Way/gi, '').replace(/[|｜]/g, '').trim();

    // 2. 【氏名】ルビ排除の日本語純化ロジック
    const nameCandidate = lines
        .filter(l => !compKeywords.test(l.text))
        .filter(l => l.h > 25)
        .sort((a, b) => b.h - a.h)[0];

    let cleanName = "";
    if (nameCandidate) {
        // 日本語（漢字・ひらがな・カタカナ）のみ抽出
        cleanName = nameCandidate.text.replace(/[^\u4E00-\u9FFF\u3040-\u309F\u30A0-\u30FF]/g, '');
    }

    // 3. 【住所】
    const addrLine = lines.find(l => /〒|[\d]{3}-[\d]{4}/.test(l.text));

    // 結果の反映
    document.getElementById('company').value = fullCompany || (lines[0] ? lines[0].text : "");
    document.getElementById('userName').value = cleanName;
    document.getElementById('address').value = addrLine ? addrLine.text : "";

    await worker.terminate();
    st.innerText = "解析完了";
};
</script>

</body>
</html>
