// OCR解析後のデータ処理（名前を固定せず、特徴で抽出）
const { data } = await worker.recognize(canvas.toDataURL());
const lines = data.lines.map(l => ({
    text: l.text.trim(),
    h: l.bbox.y1 - l.bbox.y0,
    y: l.bbox.y0
})).filter(l => l.text.length > 1);

// 1. 【会社名の特定】キーワード（属性）ベース
const compKeywords = /株式会社|株|CO|LTD|Inc|有限|通運|EXPRESS|NIPPON|LOGISTICS/i;
const companyCandidates = lines.filter(l => compKeywords.test(l.text));
// 複数あれば、より上部(yが小さい)にあるものを優先
const companyLine = companyCandidates.sort((a, b) => a.y - b.y)[0] || lines[0];

// 2. 【氏名の特定】動的サイズ判定
const nameCandidate = lines
    .filter(l => l.text !== companyLine.text) // 会社名を除外
    .filter(l => l.h > 25) // ルビ（小さい文字）を除外
    .sort((a, b) => b.h - a.h)[0]; // 残った中で最大サイズの行

// 3. 【ノイズ除去】特定の名前ではなく「記号」を消す
let finalName = "";
if (nameCandidate) {
    // 括弧、カンマ、ドット、その他OCRが誤読しやすい記号を一括除去
    finalName = nameCandidate.text.replace(/[|｜()\[\]{}.,:;!?"'_-]/g, '').trim();
    
    // 冒頭に1-2文字のアルファベット（ルビの誤認識）があれば除去
    finalName = finalName.replace(/^[A-Z]{1,2}\s/, '');
}

// 結果の反映
document.getElementById('company').value = companyLine ? companyLine.text : "";
document.getElementById('userName').value = finalName;
